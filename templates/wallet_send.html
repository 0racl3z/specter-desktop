{% extends "base.html" %}
{% block main %}
<h1>{{wallet.name}}</h1>
<div class="row">
	<a href="/wallets/{{wallet['alias']}}/tx/" class="btn radio left">Transactions</a>
	<a href="/wallets/{{wallet['alias']}}/receive/" class="btn radio">Receive</a>
	<a href="/wallets/{{wallet['alias']}}/send/" class="btn radio checked">Send</a>
	<a href="/wallets/{{wallet['alias']}}/settings/" class="btn radio right">Settings</a>
</div>
<br>
<form action="./" method="POST" class="full-width">
{% if not psbt %}
<br><h1>Sending to:</h1>
<div class="card">
	Receipient address:<br>
	<div class="row">
		<input type="text" id="address" name="address" value="{{address}}"> &nbsp;
		<a class="btn" id="scanme"><img src="/static/img/qr_tiny.svg"/> Scan</a>
	</div>
	<br><br>
	Amount:<br>
	<input type="number" name="amount" value="{{amount}}" id="amount" max="{{wallet.fullbalance}}" min=0 step="1e-8">
	<div class="note">Available: {{"%.8f" % wallet.fullbalance}}</div>
	<br><br>
	<button type="submit" onclick="showLoader()" name="action" value="createpsbt" class="btn centered">Create unsigned transaction</button>&nbsp; &nbsp; &nbsp; 
</div>
<br>
{% else %}
<div>Sending <b>{{amount}}</b> BTC to <b>{{address}}</b><br><br></div>
<div class="row">
<!-- 	{% set chunk = 700 %}
	{%for i in range( (psbt["base64"] | length)//chunk+1)%}
	<img src="{{qrcode((loop.index0 | string)+''+psbt['base64'][loop.index0*chunk:(loop.index0+1)*chunk])}}" class="qr" width="300px"/>
	{%endfor%}
 -->

	<img src="{{qrcode(psbt['base64'])}}" class="qr broad" width="500px"/>
 </div>
<div class="log"><code><pre>{{psbt['base64']}}</pre></code></div>
<div class="log"><b id="sigscount">0</b> signatures aquired</div>
<br><a class="btn centered" download='to{{address}}{{amount}}.psbt' href="data:application/octet-stream;base64,{{psbt['base64']}}">Download transaction</a>
<br>
<br><a class="btn centered" id="scanme">Scan signed transaction</a>

</div>
{% endif %}
</form>

{% endblock %}


{% block scripts %}
<div class="popup" id="popup">
	<video muted playsinline id="qr-video" class="video"></video>
</div>

<script type="module">
{% if psbt %}
	let psbt0 = "{{psbt['base64']}}";
	let sigscount = 0;
{% endif %}
	import QrScanner from "/static/qr/qr-scanner.min.js";
	QrScanner.WORKER_PATH = '/static/qr/qr-scanner-worker.min.js';

	const video = document.getElementById('qr-video');

	const scanner = new QrScanner(video, result => {
		scanner.stop();
		document.getElementById("popup").style.display = 'none';
{% if not psbt %}
		let addr = result;
		if(addr.indexOf("bitcoin:") >= 0){
			addr = addr.substr(addr.indexOf("bitcoin:")+8);
		}
		let arr = addr.split("?");
		addr = arr[0]
		document.getElementById("address").value = addr;
		if(arr.length > 1){
			arr = arr[1].split("&");
			arr.forEach((e)=>{
				if(e.startsWith("amount=")){
					document.getElementById("amount").value = parseFloat(e.substr(7));
				}
			});
		}
{% else %}

		let psbt1 = result;

		let url="/combine/";
		// console.log(url);
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() { 
			if(xmlHttp.readyState === 4 && xmlHttp.status === 200) {
				console.log(psbt0);
				console.log(psbt1);
				let o = JSON.parse(this.responseText);
				console.log(o);
				if(o.complete){
				  	window.location.replace("../tx/");
				}else{
					psbt0 = o["psbt"];
					sigscount++;
					document.getElementById("sigscount").innerHTML = sigscount;
				}
				// console.log(this.responseText);
			}else{
		  		// document.getElementById("lbl").innerHTML = "Connection failed... Trying again...";
			}
		}
		xmlHttp.onerror = function(e){
			console.log(xmlHttp);
			err = xmlHttp;
		}
		xmlHttp.open("POST", url, true); // true for asynchronous 
		// xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xmlHttp.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
		xmlHttp.send(JSON.stringify({"psbt0": psbt0, "psbt1": psbt1}));
		// xmlHttp.send(null);
{% endif %}
	});
	document.getElementById("scanme").addEventListener("click", function(){
		document.getElementById("popup").style.display = 'flex';
		scanner.start();
	});
	document.getElementById("popup").addEventListener("click", function(){
		document.getElementById("popup").style.display = 'none';
		scanner.stop();
	});
</script>
{% endblock %}